AWSTemplateFormatVersion: "2010-09-09"
Description: "for OpenSearch Resources"

Resources:
  OpenSearchServiceDomain:
    Type: AWS::OpenSearchService::Domain
    Properties:
      ClusterConfig:
        DedicatedMasterEnabled: true
        DedicatedMasterCount: 3
        DedicatedMasterType: "r6g.large.search"
        InstanceCount: 2
        InstanceType: "r6g.large.search"
        WarmEnabled: false
        ZoneAwarenessEnabled: true
        ZoneAwarenessConfig:
          AvailabilityZoneCount: 2
      CognitoOptions:
        Enabled: false
      DomainName: "test"
      DomainEndpointOptions:
        CustomEndpointEnabled: false
        EnforceHTTPS: true
        TLSSecurityPolicy: "Policy-Min-TLS-1-2-2019-07"
      EngineVersion: "OpenSearch_2.3"
      EBSOptions:
        EBSEnabled: true
        Iops: 3000 # minimum
        Throughput: 125 # minimum
        VolumeSize: 10 # minimum
        VolumeType: "gp3"
      EncryptionAtRestOptions:
        Enabled: true
        KmsKeyId: "alias/aws/es"
      LogPublishingOptions:
        ES_APPLICATION_LOGS:
          Enabled: false
        SEARCH_SLOW_LOGS:
          Enabled: false
        INDEX_SLOW_LOGS:
          Enabled: false
      NodeToNodeEncryptionOptions:
        Enabled: true
      AdvancedOptions:
        rest.action.multi.allow_explicit_index: "true"
        override_main_response_version: "true"
        indices.fielddata.cache.size: "20"
        indices.query.bool.max_clause_count: "1024"
      AdvancedSecurityOptions:
        Enabled: true
        InternalUserDatabaseEnabled: true
        MasterUserOptions:
          MasterUserName: MasterUser
          MasterUserPassword: MasterUser01!
      AccessPolicies:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              AWS: "*"
            Action: "es:ES*"
            Resource: !Sub "arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/test/*"
